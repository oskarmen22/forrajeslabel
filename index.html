<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORRAJES LABEL v05 (Fix)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .active-tab { background-color: #0f172a; color: #fbbf24; }
        .inactive-tab { color: #64748b; background-color: white; }
        .draggable { cursor: move; touch-action: none; position: absolute; user-select: none; }
        .canvas-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 10px 10px; }
        .selected-element { outline: 2px dashed #3b82f6; background: rgba(59,130,246,0.1); z-index: 10; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20 font-sans select-none">

    <!-- PANTALLA DE CARGA / ERROR -->
    <div id="loader-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-yellow-500 flex flex-col items-center gap-4 text-center px-4">
            <i data-lucide="loader" class="animate-spin w-10 h-10" id="loader-icon"></i>
            <span class="font-bold uppercase tracking-widest" id="loader-text">INICIANDO SISTEMA...</span>
            <div id="error-trace" class="hidden text-red-400 text-xs font-mono bg-black/50 p-2 rounded mt-4 max-w-sm text-left overflow-auto"></div>
        </div>
    </div>

    <!-- MODAL CONFIRMACION -->
    <div id="print-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 border-t-4 border-yellow-500 animate-in fade-in zoom-in duration-200">
            <h3 class="text-lg font-black text-slate-800 mb-2 flex items-center gap-2">
                <i data-lucide="cloud-upload" class="w-5 h-5 text-yellow-600"></i> SUBIR TIRAJE
            </h3>
            <p class="text-sm text-slate-600 mb-4">
                Se subirá la orden a la nube. La impresora la descargará automáticamente.<br>
                Rango: <span class="font-bold text-slate-900" id="modal-range">--</span>
            </p>
            <button onclick="confirmPrint()" class="w-full bg-slate-900 text-yellow-500 py-4 rounded-lg font-bold text-sm hover:bg-slate-800 shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                SUBIR A LA NUBE
            </button>
            <button onclick="closePrintModal()" class="mt-4 text-xs text-slate-400 font-bold hover:text-red-500 w-full text-center">CANCELAR</button>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-40 hidden">
        <div class="bg-white max-w-md w-full rounded-xl shadow-2xl overflow-hidden border-4 border-yellow-500 mx-4 fade-in">
            <div class="bg-yellow-500 p-6 text-center">
                <h1 class="text-3xl font-black text-slate-900">FORRAJES LABEL</h1>
                <p class="text-sm font-bold opacity-80">Acceso Cloud</p>
            </div>
            <form id="auth-form" class="p-6 space-y-4">
                <div id="login-error" class="hidden bg-red-100 text-red-600 p-2 rounded text-xs font-bold text-center">Datos incorrectos</div>
                <input type="text" id="user-input" class="w-full p-3 border-2 rounded-lg font-bold uppercase" placeholder="USUARIO">
                <input type="password" id="pass-input" class="w-full p-3 border-2 rounded-lg font-bold" placeholder="CONTRASEÑA">
                <button type="submit" class="w-full bg-slate-900 text-yellow-500 py-3 rounded-lg font-black shadow-lg">ENTRAR</button>
            </form>
        </div>
    </div>

    <!-- APP HEADER -->
    <header class="bg-slate-900 text-white p-3 shadow-md sticky top-0 z-40 flex justify-between items-center">
        <div>
            <div class="font-black text-yellow-500 leading-none">FORRAJES</div>
            <div class="text-[10px] text-slate-400 font-bold" id="user-display">--</div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Estado de la impresora en la nube -->
            <div class="flex items-center bg-slate-800 px-2 py-1 rounded text-[10px] font-bold">
                <span class="mr-1 text-slate-400">IMPRESORA:</span>
                <span id="cloud-status" class="text-yellow-500">BUSCANDO...</span>
            </div>
            <button id="logout-btn" class="bg-slate-800 p-2 rounded hover:bg-red-600"><i data-lucide="log-out" class="w-4"></i></button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-3 space-y-4">
        <!-- TABS -->
        <div class="flex gap-2 bg-white p-1 rounded-lg shadow">
            <button onclick="nav('prod')" id="nav-prod" class="flex-1 py-2 rounded text-xs font-bold flex justify-center items-center gap-2 active-tab"><i data-lucide="printer" class="w-4"></i> PROD</button>
            <button onclick="nav('design')" id="nav-design" class="flex-1 py-2 rounded text-xs font-bold flex justify-center items-center gap-2 inactive-tab"><i data-lucide="edit-3" class="w-4"></i> DISEÑO</button>
            <button onclick="nav('settings')" id="nav-settings" class="flex-1 py-2 rounded text-xs font-bold flex justify-center items-center gap-2 inactive-tab"><i data-lucide="settings" class="w-4"></i> AJUSTES</button>
        </div>

        <!-- VISTA PROD -->
        <div id="view-prod" class="grid md:grid-cols-2 gap-4">
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-slate-800">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">PRODUCTO</label>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-5"></i>
                        <input type="text" id="prod-search" class="w-full pl-10 p-2 border-2 rounded-lg font-bold text-sm uppercase outline-none focus:border-yellow-500" placeholder="BUSCAR...">
                        <div id="prod-list" class="hidden absolute top-full left-0 w-full bg-white border-2 rounded-b-lg shadow-xl z-20 max-h-40 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
                    <h2 class="text-xs font-bold text-slate-500 mb-2 uppercase">CONFIGURACIÓN</h2>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                         <div><label class="text-[9px] font-bold text-slate-400">INICIO</label><input type="number" id="inp-start" value="1" class="w-full p-2 border rounded font-mono font-bold text-center"></div>
                         <div><label class="text-[9px] font-bold text-slate-400">FIN</label><input type="number" id="inp-end" value="1" class="w-full p-2 border rounded font-mono font-bold text-center bg-yellow-50"></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setLabelSize('4x6')" id="btn-size-4x6" class="flex-1 py-1 border rounded text-[10px] font-bold bg-slate-900 text-white">4x6</button>
                        <button onclick="setLabelSize('2x2')" id="btn-size-2x2" class="flex-1 py-1 border rounded text-[10px] font-bold bg-white">2x2</button>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-white p-4 rounded-xl shadow text-center">
                    <div class="text-[10px] font-bold text-slate-400 mb-2">PREVIEW</div>
                    <div id="preview-wrapper" class="mx-auto border-2 border-dashed border-slate-300 bg-white overflow-hidden relative mb-4 h-48 flex justify-center items-center bg-slate-50"></div>
                    <button onclick="askPrint()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <i data-lucide="cloud-upload" class="w-6"></i> SUBIR TIRAJE
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA DISEÑO -->
        <div id="view-design" class="hidden bg-white p-4 rounded-xl shadow space-y-4">
            <div class="flex justify-between">
                <h2 class="font-bold text-slate-700">EDITOR</h2>
                <button onclick="saveDesign()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">GUARDAR</button>
            </div>
            <div class="bg-slate-200 p-4 rounded overflow-auto flex justify-center">
                <div id="editor-canvas" class="bg-white shadow-xl relative border border-slate-300 canvas-bg overflow-hidden"></div>
            </div>
            <div class="p-2 bg-slate-50 rounded border text-xs grid grid-cols-2 gap-2">
                <div><span class="font-bold">OBJETO:</span> <span id="prop-name" class="text-blue-600">Ninguno</span></div>
                <div class="flex gap-1">
                    <input type="number" id="val-x" class="w-12 p-1 border" placeholder="X" onchange="setProp('x',this.value)">
                    <input type="number" id="val-y" class="w-12 p-1 border" placeholder="Y" onchange="setProp('y',this.value)">
                    <input type="number" id="val-size" class="w-12 p-1 border" placeholder="SZ" onchange="setProp('size',this.value)">
                </div>
            </div>
        </div>
        
        <!-- VISTA AJUSTES -->
        <div id="view-settings" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
                <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="database" class="w-4"></i> IMPORTAR PRODUCTOS</h3>
                <textarea id="import-text" class="w-full h-24 border p-2 text-xs mb-2 font-mono rounded" placeholder="CODIGO [TAB] NOMBRE"></textarea>
                <button onclick="importProducts()" class="bg-green-600 text-white w-full py-2 rounded font-bold text-xs hover:bg-green-700">PROCESAR LISTA</button>
            </div>
        </div>

    </main>

    <!-- TOAST -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold shadow-xl z-50 hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIGURACIÓN (NO EDITAR)
        const firebaseConfig = { apiKey: "AIzaSyBFsPNR_MlgYp00Wu3UQTtYmrGc9P2B0JM", authDomain: "forrajeslabel.firebaseapp.com", projectId: "forrajeslabel", storageBucket: "forrajeslabel.firebasestorage.app", messagingSenderId: "285841575830", appId: "1:285841575830:web:79c6ac47fe8c44569297b7", measurementId: "G-HHV6KS7XXE" };
        
        // MANEJO DE ERRORES GLOBAL
        window.onerror = function(message, source, lineno, colno, error) {
             const loader = document.getElementById('loader-screen');
             const errTrace = document.getElementById('error-trace');
             const icon = document.getElementById('loader-icon');
             const text = document.getElementById('loader-text');
             
             loader.classList.remove('hidden');
             icon.classList.remove('animate-spin');
             icon.setAttribute('data-lucide', 'alert-triangle');
             text.innerText = "ERROR DE SISTEMA";
             text.className = "text-red-500 font-black";
             errTrace.classList.remove('hidden');
             errTrace.innerText = `${message}\nLinea: ${lineno}`;
             lucide.createIcons();
        };

        // INICIALIZACIÓN SEGURA
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            let state = {
                user: null, products: [], selectedProd: null, size: '4x6',
                layouts: { 
                    '4x6': { productName: {x:30,y:30,size:3}, qrCode: {x:500,y:50,size:8}, serial: {x:30,y:240,size:4}, footer: {x:30,y:720,size:2} },
                    '2x2': { productName: {x:10,y:10,size:2}, qrCode: {x:120,y:60,size:5}, serial: {x:10,y:250,size:2}, footer: {x:10,y:350,size:1} }
                }
            };

            window.addEventListener('DOMContentLoaded', () => {
                lucide.createIcons();
                
                // AUTH LISTENER
                auth.onAuthStateChanged(u => {
                    document.getElementById('loader-screen').classList.add('hidden');
                    if(u) {
                        state.user = u;
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('app-screen').classList.remove('hidden');
                        const cleanName = u.email ? u.email.split('@')[0].toUpperCase() : 'USER';
                        document.getElementById('user-display').innerText = cleanName;
                        initApp();
                    } else {
                        document.getElementById('login-screen').classList.remove('hidden');
                    }
                });

                // EVENTOS
                const loginForm = document.getElementById('login-form');
                if(loginForm) loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const u = document.getElementById('user-input').value.trim().replace(/\s/g,'').toLowerCase();
                    const p = document.getElementById('pass-input').value;
                    const email = `${u}@sistema.local`;
                    try { await signInWithEmailAndPassword(auth, email, p); } 
                    catch(err) { 
                        try { await createUserWithEmailAndPassword(auth, email, p); } 
                        catch(e2) { document.getElementById('login-error').classList.remove('hidden'); }
                    }
                });

                const logoutBtn = document.getElementById('logout-btn');
                if(logoutBtn) logoutBtn.addEventListener('click', () => auth.signOut());

                const prodSearch = document.getElementById('prod-search');
                if(prodSearch) prodSearch.addEventListener('input', (e) => {
                    const val = e.target.value.toUpperCase();
                    const list = document.getElementById('prod-list');
                    list.innerHTML = '';
                    if(val.length > 0) {
                        list.classList.remove('hidden');
                        state.products.filter(p => p.name.includes(val)).forEach(p => {
                            const div = document.createElement('div');
                            div.className = "p-2 hover:bg-slate-100 cursor-pointer border-b text-xs font-bold";
                            div.innerText = p.name;
                            div.onclick = () => {
                                state.selectedProd = p;
                                document.getElementById('prod-search').value = p.name;
                                list.classList.add('hidden');
                                renderPreview();
                            };
                            list.appendChild(div);
                        });
                    } else { list.classList.add('hidden'); }
                });
            });

            // FUNCIONES LOGICAS
            function initApp() {
                // Products
                onSnapshot(query(collection(db, "products"), orderBy("name")), s => {
                    state.products = [];
                    s.forEach(d => state.products.push(d.data()));
                });
                // Layouts
                getDoc(doc(db, "config", "layouts")).then(d => {
                    if(d.exists()) state.layouts = { ...state.layouts, ...d.data() };
                    renderDesigner(); renderPreview();
                });
                // Printer Status
                onSnapshot(doc(db, "devices", "printer_01"), (doc) => {
                    const st = document.getElementById('cloud-status');
                    if(doc.exists() && doc.data().status === 'online') {
                        st.innerText = "ONLINE"; st.className = "text-green-400 font-black";
                    } else {
                        st.innerText = "OFFLINE"; st.className = "text-red-500 font-bold";
                    }
                });
            }

            // EXPORTS GLOBALES
            window.askPrint = () => {
                if(!state.selectedProd) return showToast("Selecciona Producto", true);
                const start = document.getElementById('inp-start').value;
                const end = document.getElementById('inp-end').value;
                document.getElementById('modal-range').innerText = `${start} al ${end}`;
                document.getElementById('print-modal').classList.remove('hidden');
            };

            window.confirmPrint = async () => {
                document.getElementById('print-modal').classList.add('hidden');
                const start = parseInt(document.getElementById('inp-start').value);
                const end = parseInt(document.getElementById('inp-end').value);
                
                const d = new Date();
                const lot = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear().toString().substr(2)}`;
                const exp = `${d.getDate()}/${d.getMonth()+4}/${d.getFullYear().toString().substr(2)}`;
                const timeCode = `${d.getMonth()+1}${d.getDate()}${d.getHours()}${d.getMinutes()}`;
                const uid = state.user.uid.substring(0,4).toUpperCase();
                const qrBase = `${timeCode}${uid}`;

                const jobData = {
                    productName: state.selectedProd.name,
                    lotDate: lot, expDate: exp, qrBase: qrBase,
                    startSerial: start, endSerial: end,
                    layout: state.size === '2x2' ? 'square_2x2' : 'horizontal_4x6',
                    visualConfig: state.layouts[state.size],
                    status: "pending", timestamp: serverTimestamp()
                };

                try {
                    await setDoc(doc(db, "devices", "printer_01", "jobs", "active"), jobData);
                    showToast("¡Subido a la Nube!", false);
                    document.getElementById('inp-start').value = end + 1;
                    document.getElementById('inp-end').value = end + 1;
                } catch(e) { showToast("Error al subir", true); }
            };

            window.saveDesign = async () => {
                await setDoc(doc(db, "config", "layouts"), state.layouts);
                showToast("Diseño Guardado", false); renderPreview();
            };

            window.nav = (t) => {
                ['prod','design','settings'].forEach(x => { // Use 'settings' ID
                    document.getElementById(`view-${x}`).classList.add('hidden');
                    document.getElementById(`nav-${x}`).className = "flex-1 py-2 rounded text-xs font-bold flex justify-center items-center gap-2 inactive-tab";
                });
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.getElementById(`nav-${t}`).className = "flex-1 py-2 rounded text-xs font-bold flex justify-center items-center gap-2 active-tab";
                if(t==='design') renderDesigner();
            };

            window.setLabelSize = (s) => {
                state.size = s;
                // Update buttons UI
                const a = "flex-1 py-1 border rounded text-[10px] font-bold bg-slate-900 text-white";
                const i = "flex-1 py-1 border rounded text-[10px] font-bold bg-white";
                document.getElementById('btn-size-4x6').className = s==='4x6'?a:i;
                document.getElementById('btn-size-2x2').className = s==='2x2'?a:i;
                renderPreview(); renderDesigner();
            }

            window.closePrintModal = () => document.getElementById('print-modal').classList.add('hidden');

            window.importProducts = async () => {
                 const text = document.getElementById('import-text').value;
                 const lines = text.split('\n');
                 for(let line of lines) {
                     const [code, name] = line.split('\t');
                     if(code && name) await addDoc(collection(db, "products"), { code: code.trim(), name: name.trim() });
                 }
                 showToast("Importado", false);
            };

            // RENDERIZADO
            function renderPreview() {
                const wrap = document.getElementById('preview-wrapper');
                const layout = state.layouts[state.size];
                const scale = state.size === '4x6' ? 1.5 : 2.5;
                const w = state.size === '4x6' ? 152 : 50; const h = state.size === '4x6' ? 101 : 50;
                wrap.innerHTML = ''; wrap.style.width = (w*scale)+'px'; wrap.style.height = (h*scale)+'px';
                
                Object.keys(layout).forEach(k => {
                    const item = layout[k];
                    const el = document.createElement('div');
                    el.style.position = 'absolute';
                    el.style.left = (item.x * scale / 2) + 'px'; 
                    el.style.top = (item.y * scale / 2) + 'px';
                    el.style.fontSize = (item.size * 2 * scale) + 'px';
                    el.style.fontWeight = 'bold';
                    el.innerText = k === 'productName' ? (state.selectedProd?.name || 'PROD') : k.toUpperCase();
                    if(k==='qrCode') { el.innerText=''; el.className="bg-black w-8 h-8"; }
                    wrap.appendChild(el);
                });
            }

            let dragItem = null;
            function renderDesigner() {
                const cvs = document.getElementById('editor-canvas');
                const layout = state.layouts[state.size];
                const scale = 2;
                cvs.innerHTML = '';
                cvs.style.width = (state.size==='4x6'?304:100) + 'px'; cvs.style.height = (state.size==='4x6'?202:100) + 'px';
                Object.keys(layout).forEach(k => {
                    const item = layout[k];
                    const el = document.createElement('div');
                    el.className = "draggable border border-blue-400 bg-white/80 text-[9px] px-1 cursor-move";
                    el.innerText = k;
                    el.style.left = (item.x * scale / 2) + 'px'; el.style.top = (item.y * scale / 2) + 'px';
                    el.onmousedown = (e) => {
                        dragItem = { k, el, ox: e.clientX, oy: e.clientY, ix: item.x, iy: item.y };
                        document.onmousemove = (me) => {
                            if(!dragItem) return;
                            const dx = (me.clientX - dragItem.ox) * 2 / scale;
                            const dy = (me.clientY - dragItem.oy) * 2 / scale;
                            layout[k].x = dragItem.ix + dx; layout[k].y = dragItem.iy + dy;
                            renderDesigner();
                        };
                        document.onmouseup = () => { document.onmousemove = null; dragItem = null; };
                    };
                    cvs.appendChild(el);
                });
            }

            // SETTERS PROPS (Simplificado para drag)
            window.setProp = (k, v) => {
                if(dragItem) state.layouts[state.size][dragItem.k][k] = parseInt(v);
            }

            function showToast(msg, err) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.className = `fixed top-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-xs font-bold shadow-xl z-50 ${err ? 'bg-red-600 text-white' : 'bg-green-600 text-white'}`;
                t.classList.remove('hidden');
                setTimeout(() => t.classList.add('hidden'), 3000);
            }

            // Init
            nav('prod');

        } catch (error) {
             console.error("Critical Init Error:", error);
        }
    </script>
</body>
</html>
